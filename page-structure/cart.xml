<?xml version="1.0" encoding="UTF-8"?>
<!-- 
  {IoTBay Shopping Cart Page Structure}
  {This XML describes cart.jsp - the shopping cart page where users manage items before checkout}
  {Purpose: Document cart structure, item management, and checkout preparation}
-->
<page name="cart" type="shopping-cart" jsp-file="cart.jsp">
  
  <metadata>
    <title>Shopping Cart - IoTBay</title>
    <description>Review and manage items in your shopping cart</description>
    <route>/cart</route>
    <template>t:base</template>
    <authentication>optional</authentication>
    <!-- {Cart can be accessed by guests, but checkout requires login} -->
  </metadata>

  <structure>
    
    <!-- {Page Header} -->
    <section name="page-header">
      <breadcrumb>
        <item name="Home" route="/"/>
        <item name="Cart" active="true"/>
      </breadcrumb>
      <title>Shopping Cart</title>
      <item-count>
        <!-- {Shows: "X items in your cart"} -->
      </item-count>
    </section>

    <!-- {Main Cart Content} -->
    <section name="cart-content" type="two-column">
      
      <!-- {Left Column: Cart Items} -->
      <column name="cart-items" width="65%">
        
        <!-- {Cart Items List} -->
        <cart-items>
          <cart-item>
            <!-- {Each cart item row} -->
            <product-image>
              <image source="/images/products/{productId}.png" alt="{productName}"/>
              <!-- {Product thumbnail image} -->
            </product-image>
            
            <product-info>
              <name>{Product Name}</name>
              <!-- {Product name, links to product details} -->
              <category>{Category Name}</category>
              <!-- {Category badge/tag} -->
              <specs>
                <!-- {Key technical specs: protocol, voltage, etc.} -->
                <spec name="protocol">{LoRaWAN|Zigbee|etc}</spec>
                <spec name="voltage">{12V|24V|etc}</spec>
              </specs>
            </product-info>
            
            <quantity-controls>
              <!-- {Quantity selector: decrease, input, increase buttons} -->
              <button type="decrease" action="decreaseQuantity"/>
              <input type="number" value="{quantity}" min="1" max="{stockQuantity}"/>
              <button type="increase" action="increaseQuantity"/>
            </quantity-controls>
            
            <price>
              <unit-price currency="USD">{unitPrice}</unit-price>
              <!-- {Price per unit} -->
              <total-price currency="USD">{totalPrice}</total-price>
              <!-- {Price Ã— quantity} -->
            </price>
            
            <actions>
              <button type="remove" action="removeFromCart" text="Remove"/>
              <!-- {Remove item from cart} -->
              <button type="save-for-later" action="saveForLater" text="Save for Later"/>
              <!-- {Move to wishlist/saved items} -->
            </actions>
          </cart-item>
        </cart-items>

        <!-- {Empty Cart State} -->
        <empty-state condition="cart-empty">
          <!-- {Shown when cart has no items} -->
          <icon>cart-icon</icon>
          <title>Your cart is empty</title>
          <message>Add some products to get started</message>
          <action>
            <button type="primary" route="/browse" text="Browse Products"/>
          </action>
        </empty-state>

        <!-- {Cart Actions - Bottom of items list} -->
        <cart-actions>
          <button type="secondary" route="/browse" text="Continue Shopping"/>
          <!-- {Return to product browsing} -->
          <button type="secondary" action="clearCart" text="Clear Cart"/>
          <!-- {Remove all items from cart} -->
        </cart-actions>

      </column>

      <!-- {Right Column: Order Summary} -->
      <column name="order-summary" width="35%">
        
        <summary-card>
          <!-- {Sticky order summary card} -->
          <title>Order Summary</title>
          
          <summary-details>
            <row name="subtotal">
              <label>Subtotal</label>
              <value currency="USD">{subtotal}</value>
              <!-- {Sum of all item prices} -->
            </row>
            
            <row name="shipping">
              <label>Shipping</label>
              <value>
                <!-- {Shipping cost or "Free shipping" message} -->
                <free-shipping condition="subtotal >= 50">Free shipping on orders over $50</free-shipping>
                <shipping-cost condition="subtotal < 50" currency="USD">{shippingCost}</shipping-cost>
              </value>
            </row>
            
            <row name="tax">
              <label>Tax</label>
              <value currency="USD">{tax}</value>
              <!-- {Calculated tax based on location} -->
            </row>
            
            <row name="discount" condition="hasDiscount">
              <!-- {Optional discount row} -->
              <label>Discount</label>
              <value currency="USD" type="negative">-{discountAmount}</value>
            </row>
          </summary-details>
          
          <divider/>
          <!-- {Visual separator} -->
          
          <total>
            <label>Total</label>
            <value currency="USD" emphasis="bold">{total}</value>
            <!-- {Final total including all fees} -->
          </total>
          
          <checkout-button>
            <button type="primary" route="/checkout" text="Proceed to Checkout" size="large" full-width="true"/>
            <!-- {Primary CTA to proceed to checkout} -->
          </checkout-button>
          
          <security-badges>
            <!-- {Trust indicators: secure payment, SSL, etc.} -->
            <badge icon="lock" text="Secure Checkout"/>
            <badge icon="shield" text="SSL Encrypted"/>
          </security-badges>
        </summary-card>

        <!-- {Compatibility Warnings} -->
        <compatibility-warnings condition="hasWarnings">
          <!-- {Shown if cart items have compatibility issues} -->
          <warning type="voltage-mismatch">
            <icon>warning-icon</icon>
            <message>Voltage mismatch detected. Some items may not be compatible.</message>
            <action>
              <button type="link" text="View Details" action="showCompatibilityDetails"/>
            </action>
          </warning>
        </compatibility-warnings>

        <!-- {Recommended Products} -->
        <recommended-products>
          <title>You May Also Like</title>
          <product-grid columns="1">
            <!-- {Vertical list of recommended products} -->
            <product-card compact="true">
              <!-- {Compact product card for sidebar} -->
            </product-card>
          </product-grid>
        </recommended-products>

      </column>

    </section>

  </structure>

  <!-- {Cart Functionality} -->
  <functionality>
    <update-quantity>
      <!-- {Update item quantity without page reload} -->
      <method>AJAX</method>
      <endpoint>/api/cart/update</endpoint>
      <optimistic-update>true</optimistic-update>
      <!-- {Update UI immediately, rollback on error} -->
    </update-quantity>
    
    <remove-item>
      <!-- {Remove item from cart} -->
      <method>AJAX</method>
      <endpoint>/api/cart/remove</endpoint>
      <confirmation>false</confirmation>
      <!-- {No confirmation needed for remove} -->
    </remove-item>
    
    <persist-cart>
      <!-- {Cart persistence strategy} -->
      <guest>sessionStorage</guest>
      <!-- {Guest users: store in sessionStorage} -->
      <authenticated>server-side</authenticated>
      <!-- {Logged-in users: store in database} -->
    </persist-cart>
  </functionality>

  <!-- {Refactoring Context} -->
  <refactoring-context>
    <current-state>
      <issues>
        <issue>Cart updates require full page reload</issue>
        <issue>No optimistic UI updates for better perceived performance</issue>
        <issue>Compatibility checking not implemented</issue>
        <issue>Cart persistence for guests could be improved</issue>
        <issue>Mobile layout needs optimization (stack columns vertically)</issue>
      </issues>
    </current-state>
    <target-state>
      <improvements>
        <improvement>Implement AJAX cart updates with optimistic UI</improvement>
        <improvement>Add real-time compatibility checking</improvement>
        <improvement>Persist guest cart in localStorage with expiration</improvement>
        <improvement>Add cart item animations (add/remove feedback)</improvement>
        <improvement>Implement save for later functionality</improvement>
        <improvement>Add cart item notes/instructions field</improvement>
        <improvement>Mobile: Stack columns, sticky summary at bottom</improvement>
      </improvements>
    </target-state>
  </refactoring-context>

  <dependencies>
    <component name="header" file="components/header.jsp"/>
    <component name="footer" file="components/footer.jsp"/>
    <component name="cart-item" file="components/cart-item.jsp"/>
    <component name="order-summary" file="components/order-summary.jsp"/>
    <layout name="base" file="WEB-INF/tags/base.tag"/>
  </dependencies>

</page>

